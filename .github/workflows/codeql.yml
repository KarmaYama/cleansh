# .github/workflows/codeql-advanced.yml
# This file was autogenerated by github/codeql-action.
# It is designed to be largely self-configuring.
#
# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
#
# ******** NOTE ********
# We have attempted to detect the languages in your repository. Please check
# the `language` matrix defined below to confirm you have the correct set of
# supported CodeQL languages.
#
name: "CodeQL Advanced"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '24 4 * * 6' # Weekly on Saturday at 04:24 UTC

jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    # Runner size impacts CodeQL analysis time. To learn more, please see:
    #   - https://gh.io/recommended-hardware-resources-for-running-codeql
    #   - https://gh.io/supported-runners-and-hardware-resources
    #   - https://gh.io/using-larger-runners (GitHub.com only)
    # Consider using larger runners or machines with greater resources for possible analysis time improvements.
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
    permissions:
      # required for all workflows
      security-events: write

      # required to fetch internal or private CodeQL packs
      packages: read

      # only required for workflows in private repositories
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
        - language: actions
          build-mode: none
        - language: javascript-typescript
          build-mode: none
        - language: rust
          build-mode: none # Keep build-mode as 'none' per CodeQL requirement.

        # CodeQL supports the following values keywords for 'language': 'actions', 'c-cpp', 'csharp', 'go', 'java-kotlin', 'javascript-typescript', 'python', 'ruby', 'rust', 'swift'
        # Use `c-cpp` to analyze code written in C, C++ or both
        # Use 'java-kotlin' to analyze code written in Java, Kotlin or both
        # Use 'javascript-typescript' to analyze code written in JavaScript, TypeScript or both
        # To learn more about changing the languages that are analyzed or customizing the build mode for your analysis,
        # see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning.
        # If you are analyzing a compiled language, you can modify the 'build-mode' for that language to customize how
        # your codebase is analyzed, see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/codeql-code-scanning-for-compiled-languages
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive # Important for repos with submodules

    # --- START OF RUST ENVIRONMENT SETUP FOR CODEQL ---
    # This step ensures that all necessary targets are available for CodeQL's internal build.
    - if: matrix.language == 'rust'
      name: Prepare Rust environment for CodeQL
      shell: bash
      run: |
        echo "Preparing Rust environment for CodeQL analysis..."

        # Update and set default Rust toolchain (stable is usually good unless specified otherwise)
        rustup update --no-self-update stable
        rustup default stable
        rustup show

        # Define targets from your [dist] config that can be installed on Linux/macOS runners.
        # We explicitly omit x86_64-pc-windows-msvc for Linux/macOS runners due to cross-compilation complexity.
        # For comprehensive MSVC analysis, consider a dedicated job on a 'windows-latest' runner.
        LINUX_TARGETS="aarch64-unknown-linux-gnu x86_64-unknown-linux-musl"
        MACOS_TARGETS="aarch64-apple-darwin x86_64-apple-darwin"

        targets_to_add=""

        if [[ "${{ runner.os }}" == "Linux" ]]; then
          echo "On Linux runner, checking for Linux cross-compilation targets."
          for target in $LINUX_TARGETS; do
            if ! rustup target list | grep -q "$target (installed)"; then
              targets_to_add+=" $target"
            fi
          done
        elif [[ "${{ runner.os }}" == "macOS" ]]; then
          echo "On macOS runner, checking for Apple targets."
          for target in $MACOS_TARGETS; do
            if ! rustup target list | grep -q "$target (installed)"; then
              targets_to_add+=" $target"
            fi
          done
        elif [[ "${{ runner.os }}" == "Windows" ]]; then
          echo "On Windows runner, native Windows targets are usually sufficient."
          # If you ever run this job on Windows, and need specific MSVC targets, you might add them here.
          # Example: if ! rustup target list | grep -q 'x86_64-pc-windows-msvc (installed)'; then targets_to_add+=" x86_64-pc-windows-msvc"; fi
        fi

        if [ -n "$targets_to_add" ]; then
          echo "Adding Rust targets: $targets_to_add"
          # Use 'sh' compatibility for rustup target add
          rustup target add $targets_to_add || echo "Warning: Failed to add some Rust targets. Code analysis for these might be incomplete."
        else
          echo "All necessary Rust targets already installed or not applicable for this runner."
        fi

        echo "Rust environment preparation complete."
    # --- END OF RUST ENVIRONMENT SETUP FOR CODEQL ---

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}
        # Pass arguments to CodeQL's internal Rust autobuilder to maximize coverage.
        # We aim to build for all applicable targets on the current runner.
        # Use `--all-targets` to build binaries, examples, tests, benches.
        # Use `--release` for release profiles as they may have different optimizations.
        # Conditional targets are added based on the runner OS and your `[dist]` config.
        build-arguments: |
          ${{ matrix.language == 'rust' && '--release' || '' }}
          ${{ matrix.language == 'rust' && runner.os == 'Linux' && '--all-targets --target aarch64-unknown-linux-gnu --target x86_64-unknown-linux-musl' || '' }}
          ${{ matrix.language == 'rust' && runner.os == 'macOS' && '--all-targets --target aarch64-apple-darwin --target x86_64-apple-darwin' || '' }}
          # If you had a dedicated Windows runner for CodeQL analysis, you would add its specific targets here:
          # ${{ matrix.language == 'rust' && runner.os == 'Windows' && '--all-targets --target x86_64-pc-windows-msvc' || '' }}
        # If you wish to specify custom queries, you can do so here or in a config file.
        # By default, queries listed here will override any specified in a config file.
        # Prefix the list here with "+" to use these queries and those in the config file.

        # For more details on CodeQL's query packs, refer to: https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-queries-in-ql-packs
        # queries: security-extended,security-and-quality

    # This 'run' step is left here from the original template for other languages.
    # For Rust, with build-mode: none, CodeQL handles the build internally.
    - if: matrix.build-mode == 'manual'
      shell: bash
      run: |
        echo 'If you are using a "manual" build mode for one or more of the' \
          'languages you are analyzing, replace this with the commands to build' \
          'your code, for example:'
        echo '  make bootstrap'
        echo '  make release'
        # Do NOT exit 1 here, as other languages might actually use this.
        # However, for Rust, this block will NOT execute due to `build-mode: none`.

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"
